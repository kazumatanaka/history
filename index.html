<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ê≠¥Âè≤ÁÑ°Âèå -HISTORY SAMURAI-</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;700;900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap"
        rel="stylesheet">

    <style>
        :root {
            /* Pop & Cute Ninja Palette */
            --primary: #FF4081;
            /* Pink pop */
            --primary-glow: #ff80ab;
            --accent: #FFCA28;
            /* Bright Yellow Gold */
            --accent-glow: #ffe082;
            --bg-dark: #fff3e0;
            /* Cream/Orange */
            --text-main: #3e2723;
            /* Dark Brown for clear pop UI text */
            --font-main: 'M PLUS Rounded 1c', sans-serif;
            --font-game: 'M PLUS Rounded 1c', sans-serif;

            /* Card Rarity Colors */
            --color-n: #8d6e63;
            --color-r: #cfd8dc;
            --color-sr: #ffd54f;
            --color-ssr: #e1f5fe;

            --card-width: 300px;
            --card-height: 460px;
            --menu-width: 450px;
        }

        * {
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-dark);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100dvh;
            overflow: hidden;
            color: var(--text-main);
            user-select: none;
            /* Pop Pattern Background */
            background-image:
                radial-gradient(#ffcc80 15%, transparent 16%),
                radial-gradient(#ffcc80 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
        }

        h1,
        h2,
        h3 {
            font-family: var(--font-main);
            letter-spacing: 0.05em;
            color: var(--primary);
            text-shadow: 2px 2px 0px #fff;
            font-weight: 900;
        }

        button {
            font-family: var(--font-main);
            letter-spacing: 0.1em;
        }

        h1 {
            font-size: 2.5rem;
            -webkit-text-stroke: 1.5px #fff;
            filter: drop-shadow(0 4px 2px rgba(255, 64, 129, 0.3));
        }

        #main-wrapper {
            width: 100%;
            max-width: 600px;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--primary);
            border-right: 4px solid var(--primary);
        }

        .overlay-screen {
            position: absolute;
            inset: 0;
            background: rgba(255, 243, 224, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            transition: opacity 0.5s ease;
        }

        .hidden {
            display: none !important;
        }

        .menu-list {
            width: 100%;
            max-width: var(--menu-width);
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            padding: 5px 10px;
            max-height: 80vh;
        }

        /* Cute Button Style */
        .slash-btn {
            position: relative;
            background: #fff;
            border: 4px solid var(--primary);
            border-radius: 12px;
            padding: 12px 20px;
            text-align: left;
            color: var(--text-main);
            font-family: var(--font-main);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            box-shadow: 0 6px 0 var(--primary);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 100%;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .slash-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 64, 129, 0.1), transparent);
            transition: left 0.5s;
        }

        .slash-btn:hover {
            background: #fffafa;
            border-color: var(--primary-glow);
            box-shadow: 0 4px 0 var(--primary-glow);
            transform: translateY(2px);
        }

        .slash-btn:hover::before {
            left: 100%;
        }

        .slash-btn:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 var(--primary);
        }

        .btn-title {
            font-size: 1.2rem;
            font-weight: 900;
        }

        .btn-sub {
            font-size: 0.75rem;
            color: #ff80ab;
            text-transform: uppercase;
            margin-top: 2px;
            font-weight: bold;
            letter-spacing: 0.05em;
        }

        .btn-icon {
            font-size: 1.8rem;
            opacity: 1;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .slash-btn:hover .btn-icon {
            transform: scale(1.2) rotate(15deg);
        }

        .quit-btn {
            background: #FFCA28;
            border: 2px solid #FF8F00;
            border-radius: 20px;
            color: #fff;
            padding: 10px 24px;
            cursor: pointer;
            font-family: var(--font-main);
            margin-top: 30px;
            font-size: 1rem;
            font-weight: 900;
            letter-spacing: 0.1em;
            box-shadow: 0 4px 0 #FF8F00;
            transition: all 0.2s;
        }

        .quit-btn:hover {
            background: #FFD54F;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #FF8F00;
        }

        .quit-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #FF8F00;
        }

        .quit-btn.gray-out {
            background: #e0e0e0 !important;
            border-color: #9e9e9e !important;
            color: #757575 !important;
            box-shadow: 0 4px 0 #9e9e9e !important;
        }

        .quit-btn.gray-out:hover {
            background: #f5f5f5 !important;
            box-shadow: 0 2px 0 #9e9e9e !important;
        }

        .quit-btn.gray-out:active {
            box-shadow: 0 0 0 #9e9e9e !important;
        }

        /* Flash Card Action Buttons */
        .fc-btn {
            padding: 12px;
            font-size: 1.1rem;
            color: #fff;
            margin-bottom: 0;
            border-width: 3px;
        }

        .memo-btn {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            border-color: #1b5e20;
            box-shadow: 0 4px 0 #1b5e20;
        }

        .memo-btn:active {
            box-shadow: 0 0 0 #1b5e20;
        }

        .norm-btn {
            background: linear-gradient(135deg, #2196f3, #1565c0);
            border-color: #0d47a1;
            box-shadow: 0 4px 0 #0d47a1;
        }

        .norm-btn:active {
            box-shadow: 0 0 0 #0d47a1;
        }

        .weak-btn {
            background: linear-gradient(135deg, #f44336, #c62828);
            border-color: #b71c1c;
            box-shadow: 0 4px 0 #b71c1c;
        }

        .weak-btn:active {
            box-shadow: 0 0 0 #b71c1c;
        }

        /* „Ç≤„Éº„É†ÁîªÈù¢ */
        .status-bar {
            flex: 0 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 40px 20px 10px 20px;
            /* Added top padding to clear absolute toggles */
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 4px dashed var(--primary-glow);
            color: var(--primary);
            font-weight: 900;
        }

        .hp-bar {
            width: 100%;
            height: 16px;
            background: #ffe0b2;
            border: 2px solid #ff9800;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 5px;
        }

        .hp-fill {
            height: 100%;
            transition: width 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #p-hp {
            background: #4caf50;
            width: 100%;
        }

        #e-hp {
            background: #f44336;
            width: 100%;
        }

        #battle-stage {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 20px;
        }

        #enemy-samurai {
            width: 200px;
            height: 200px;
            background: url('./assets/images/enemy_samurai_pop.png') no-repeat bottom center;
            background-size: contain;
            animation: sway 2s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(255, 64, 129, 0.4));
        }

        @keyframes sway {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            50% {
                transform: translateY(-10px) rotate(2deg);
            }
        }

        #slash {
            position: absolute;
            top: 50%;
            left: 10%;
            width: 0%;
            height: 10px;
            background: #fff;
            border-radius: 50px;
            box-shadow: 0 0 15px 5px var(--accent);
            transform: rotate(-25deg);
            pointer-events: none;
        }

        .slash-anim {
            animation: slash 0.3s forwards;
        }

        @keyframes slash {
            0% {
                width: 0%;
                opacity: 1;
                transform: rotate(-25deg) scale(0.5);
            }

            50% {
                width: 120%;
                opacity: 1;
                transform: rotate(-25deg) scale(1.5);
            }

            100% {
                width: 120%;
                opacity: 0;
                transform: rotate(-25deg) scale(1.2);
            }
        }

        .ui-mid {
            background: #fff;
            padding: 15px;
            text-align: center;
            border-top: 4px solid var(--primary);
            position: relative;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            margin-top: -30px;
            /* Pull UI up further */
        }

        #timer-gauge {
            width: 100%;
            height: 8px;
            background: #ffe0b2;
            border-radius: 4px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        #timer-fill {
            width: 100%;
            height: 100%;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary-glow);
            transition: width 0.1s linear;
        }

        #event-name {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--text-main);
            margin-bottom: 5px;
            min-height: 2rem;
        }

        #hint-text {
            font-size: 1rem;
            font-weight: bold;
            color: #FF8F00;
            min-height: 1.2rem;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #input-display {
            font-size: 3.5rem;
            font-family: var(--font-main);
            font-weight: 900;
            letter-spacing: 0.2em;
            color: var(--primary);
            text-shadow: 2px 2px 0 var(--accent);
            margin-top: 5px;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 10px;
            background: #fff3e0;
        }

        .key {
            background: #fff;
            color: var(--primary);
            border: 3px solid #ffcc80;
            border-radius: 12px;
            padding: 11px;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: 900;
            font-family: var(--font-main);
            cursor: pointer;
            box-shadow: 0 4px 0 #ffcc80;
            transition: all 0.1s;
        }

        .key:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #ffcc80;
            background: #fff9c4;
        }

        .key.ok {
            background: var(--primary);
            color: #fff;
            border-color: #d81b60;
            box-shadow: 0 4px 0 #d81b60;
        }

        .key.ok:active {
            box-shadow: 0 0 0 #d81b60;
            background: #c2185b;
            transform: translateY(4px);
        }

        /* „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ */
        #collection-ui {
            display: flex;
            flex-direction: column;
            background: #fff3e0;
            padding: 0;
            align-items: center;
        }

        #col-header {
            width: 100%;
            max-width: var(--menu-width);
            padding: 40px 15px 15px 15px;
            /* Added top padding to prevent BGM toggle overlap */
            background: #fff;
            border-bottom: 4px solid var(--primary);
            color: var(--primary);
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #col-grid {
            width: 100%;
            max-width: var(--menu-width);
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: max-content;
            gap: 15px 10px;
            align-content: start;
        }

        .col-card {
            aspect-ratio: 2/3;
            min-height: 130px;
            background: #fff;
            border: 3px solid #555;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            padding: 4px;
            cursor: pointer;
            position: relative;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .col-card:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0, 0, 0, 0.2);
        }

        .col-card.r1 {
            border-color: var(--color-n);
            background: #000;
            color: #fff;
        }

        .col-card.r2 {
            border: none;
            padding: 7px;
            background: linear-gradient(135deg, #7f7f7f 0%, #dcdcdc 20%, #ffffff 50%, #dcdcdc 80%, #7f7f7f 100%);
            box-shadow: 0 4px 0 #9e9e9e;
            color: #000;
        }

        .col-card.r3 {
            border: none;
            padding: 7px;
            background: linear-gradient(135deg, #b8860b 0%, #ffd700 20%, #ffeb3b 50%, #ffd700 80%, #b8860b 100%);
            box-shadow: 0 4px 0 #f57f17;
            color: #000;
        }

        .col-card.r4 {
            border: 3px solid transparent;
            background-image: linear-gradient(#fff, #fff), linear-gradient(135deg, #ff9a9e 0%, #fecfef 20%, #a18cd1 40%, #fbc2eb 60%, #8fd3f4 80%, #ff9a9e 100%);
            background-origin: border-box;
            background-clip: content-box, border-box;
            box-shadow: 0 4px 0 #ce93d8, 0 0 10px rgba(255, 105, 180, 0.5);
            color: #000;
            position: relative;
            overflow: hidden;
        }

        .col-card.r4::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.8) 50%, rgba(255, 255, 255, 0) 100%);
            transform: skewX(-25deg);
            animation: col-holo-sweep 3s infinite;
        }

        @keyframes col-holo-sweep {
            0% {
                left: -100%;
            }

            20% {
                left: 200%;
            }

            100% {
                left: 200%;
            }
        }

        .col-card-num {
            font-size: 0.6rem;
            opacity: 0.8;
            width: 100%;
            text-align: left;
            padding-left: 2px;
            font-weight: bold;
        }

        .col-card-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e91e63;
            color: #fff;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .col-card-name {
            font-size: 0.8rem;
            font-weight: 900;
            width: 100%;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.5);
        }

        .col-card.r1 .col-card-name {
            text-shadow: none;
        }

        /* „Ç´„Éº„ÉâË©≥Á¥∞„É¢„Éº„ÉÄ„É´ („Ç´„Éº„Éâ„Å®ËÉåÊôØ„ÇíÂàÜÈõ¢) */
        #card-modal {
            position: absolute;
            inset: 0;
            background: rgba(255, 243, 224, 0.95);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #card-view-node {
            position: relative;
            z-index: 210;
            pointer-events: auto;
        }

        #modal-close-btn {
            position: relative;
            margin-top: 20px;
            font-size: 1.2rem;
            background: rgba(183, 28, 28, 0.8);
            color: #fff;
            border: 1px solid #ff5252;
            z-index: 210;
        }

        #modal-bg-trigger {
            position: absolute;
            inset: 0;
            z-index: 205;
            cursor: pointer;
        }

        .flip-container {
            perspective: 1000px;
            width: var(--card-width);
            height: var(--card-height);
            cursor: pointer;
        }

        .flip-container.flipped .flipper {
            transform: rotateY(180deg);
        }

        .flipper {
            transition: 0.6s;
            transform-style: preserve-3d;
            position: relative;
            width: 100%;
            height: 100%;
        }

        .front,
        .back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
            overflow: hidden;
            box-sizing: border-box;
        }

        /* --- Ë°®Èù¢„Éá„Ç∂„Ç§„É≥ --- */
        .front {
            z-index: 2;
            transform: rotateY(0deg);
            padding: 8px;
            background: #000;
            border: 6px solid #555;
        }

        .front[data-rarity="1"] {
            border-color: var(--color-n);
        }

        .front[data-rarity="2"] {
            /* Silver / ÈäÄ */
            border: 4px solid #fff;
            background: #fff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
            animation: silver-pulse 2s ease-in-out infinite alternate;
        }

        .front[data-rarity="2"]::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            right: -100%;
            bottom: -100%;
            background: conic-gradient(from 0deg at 50% 50%,
                    #ffffff, #e0e0e0, #9e9e9e, #e0e0e0, #ffffff, #e0e0e0, #9e9e9e, #e0e0e0, #ffffff);
            animation: holo-spin 6s linear infinite;
            z-index: 0;
        }

        @keyframes silver-pulse {
            0% {
                box-shadow: 0 0 15px rgba(255, 255, 255, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.5);
            }

            100% {
                box-shadow: 0 0 40px rgba(255, 255, 255, 1), 0 0 20px rgba(200, 200, 255, 0.9), inset 0 0 30px rgba(255, 255, 255, 1);
            }
        }

        .front[data-rarity="3"] {
            /* Gold / Èáë */
            border: 4px solid #fff;
            background: #fff;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), inset 0 0 15px rgba(255, 235, 59, 0.6);
            position: relative;
            overflow: hidden;
            animation: gold-pulse 2s ease-in-out infinite alternate;
        }

        .front[data-rarity="3"]::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            right: -100%;
            bottom: -100%;
            background: conic-gradient(from 0deg at 50% 50%,
                    #ffeb3b, #fbc02d, #f57f17, #fbc02d, #ffeb3b, #fbc02d, #f57f17, #fbc02d, #ffeb3b);
            animation: holo-spin 6s linear infinite;
            z-index: 0;
        }

        @keyframes gold-pulse {
            0% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), inset 0 0 15px rgba(255, 235, 59, 0.6);
            }

            100% {
                box-shadow: 0 0 60px rgba(255, 223, 0, 1), 0 0 30px rgba(255, 255, 255, 0.9), inset 0 0 40px rgba(255, 255, 255, 1);
            }
        }



        /* Aurora / Ëôπ (Hologram SSR) */
        .front[data-rarity="4"] {
            border: 4px solid #fff;
            background: #fff;
            /* Base for blend modes */
            box-shadow:
                0 0 20px rgba(255, 105, 180, 0.5),
                0 0 40px rgba(0, 255, 255, 0.4),
                inset 0 0 15px rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
            /* Contains the hologram layers */
            animation: holo-pulse 3s ease-in-out infinite alternate;
        }

        .front[data-rarity="4"]::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            right: -100%;
            bottom: -100%;
            background: conic-gradient(from 0deg at 50% 50%,
                    #ff6ec7, #ff9a9e, #fecfef, #a18cd1, #fbc2eb, #8fd3f4, #00f2fe, #4facfe, #00f2fe, #8fd3f4, #fbc2eb, #a18cd1, #fecfef, #ff9a9e, #ff6ec7);
            animation: holo-spin 6s linear infinite;
            z-index: 0;
        }

        @keyframes holo-spin {
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes holo-pulse {
            0% {
                box-shadow: 0 0 20px #ff6ec7, 0 0 40px #00f2fe, inset 0 0 15px #fff;
            }

            50% {
                box-shadow: 0 0 35px #fbc2eb, 0 0 60px #8fd3f4, inset 0 0 25px #fff;
            }

            100% {
                box-shadow: 0 0 20px #a18cd1, 0 0 40px #4facfe, inset 0 0 15px #fff;
            }
        }

        /* Ëºù„Åè„Éï„É¨„Éº„É†ÂäπÊûú („É¨„Ç¢‰ª•‰∏ä)„ÅÆ„Éè„Ç§„É©„Ç§„Éà */
        .front[data-rarity="2"]::after,
        .front[data-rarity="3"]::after {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            right: -100%;
            bottom: -100%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0) 40%);
            mix-blend-mode: overlay;
            animation: holo-gleam 4s ease-in-out infinite alternate;
            z-index: 100;
            pointer-events: none;
        }

        /* SSRÁâπÊúâ„ÅÆÂº∑ÁÉà„Å™„Éõ„É≠„Ç∞„É©„É†ÂèçÂ∞Ñ */
        .front[data-rarity="4"]::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(105deg,
                    transparent 20%,
                    rgba(255, 255, 255, 0.9) 25%,
                    rgba(255, 200, 255, 0.8) 28%,
                    transparent 33%,
                    transparent 67%,
                    rgba(200, 255, 255, 0.9) 72%,
                    rgba(255, 255, 255, 0.8) 75%,
                    transparent 80%);
            mix-blend-mode: color-dodge;
            background-size: 300% 300%;
            animation: ssr-holo-sweep 4s ease-in-out infinite alternate;
            z-index: 100;
            pointer-events: none;
        }

        @keyframes ssr-holo-sweep {
            0% {
                background-position: 100% 100%;
                filter: hue-rotate(0deg) brightness(1);
            }

            50% {
                filter: hue-rotate(90deg) brightness(1.2);
            }

            100% {
                background-position: 0% 0%;
                filter: hue-rotate(180deg) brightness(1);
            }
        }

        @keyframes holo-gleam {
            0% {
                transform: scale(1) translate(10%, 10%);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.5) translate(-10%, -10%);
                opacity: 1;
            }

            100% {
                transform: scale(1) translate(10%, -10%);
                opacity: 0.5;
            }
        }



        .front-inner {
            width: 100%;
            height: 100%;
            background: #fff;
            border-radius: 10px;
            position: relative;
            border: 2px solid #000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            z-index: 5;
            /* Ensure content is above hologram layers */
        }

        .front[data-rarity="2"] .front-inner,
        .front[data-rarity="3"] .front-inner {
            border-width: 10px;
        }

        .card-bg {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 50%, #4FC3F7 50%, #0288D1 100%);
            z-index: 0;
        }

        .card-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 80px;
            z-index: 10;
        }

        .era-badge {
            position: absolute;
            top: -5px;
            left: -5px;
            width: 70px;
            height: 70px;
            background: #2196f3;
            border: 2px solid #fff;
            clip-path: polygon(0 0, 100% 0, 100% 60%, 50% 100%, 0 60%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-family: var(--font-game);
            font-weight: 900;
            z-index: 20;
            padding-bottom: 5px;
            line-height: 1;
        }

        .era-icon {
            font-size: 1.5rem;
            margin-bottom: 2px;
        }

        .era-text {
            font-size: 0.7rem;
        }

        .name-container {
            position: absolute;
            top: 5px;
            left: 65px;
            right: 65px;
            text-align: center;
            z-index: 15;
        }

        .card-title {
            display: inline-block;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            font-size: 0.6rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .card-name {
            font-family: var(--font-game);
            font-size: 1.6rem;
            font-weight: 900;
            color: #fff;
            -webkit-text-stroke: 1px #000;
            text-shadow: 2px 2px 0 #000;
            white-space: nowrap;
        }

        .rarity-star {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 60px;
            height: 60px;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .star-svg {
            width: 100%;
            height: 100%;
            fill: #ffd700;
            stroke: #d4af37;
            stroke-width: 2px;
            filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.5));
        }

        .rarity-text {
            position: absolute;
            font-family: var(--font-game);
            font-weight: 900;
            font-size: 1rem;
            color: #fff;
            text-shadow: 1px 1px 0 #000;
            transform: rotate(15deg);
        }

        .card-char-img {
            position: absolute;
            bottom: 85px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-height: 65%;
            object-fit: contain;
            z-index: 5;
            filter: drop-shadow(0 5px 5px rgba(0, 0, 0, 0.4));
        }

        .card-no {
            position: absolute;
            bottom: 95px;
            right: 5px;
            background: #000;
            color: #fff;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 6;
            font-family: sans-serif;
        }

        .card-bottom {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 90px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 5px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .stats-row {
            display: flex;
            width: fit-content;
            align-self: center;
            justify-content: center;
            gap: 6px;
            align-items: center;
            margin-top: -15px;
            flex-wrap: nowrap;
        }

        .stat-pill {
            background: #333;
            border: 2px solid #fff;
            border-radius: 8px;
            padding: 4px 6px;
            font-family: var(--font-game);
            font-weight: bold;
            font-size: 0.65rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            min-width: 80px;
        }

        .stat-val {
            font-size: 1.1rem;
            margin-top: 3px;
            line-height: 1;
        }

        .stat-pill.str {
            background: #5d4037;
            border-color: #ffca28;
        }

        .stat-pill.int {
            background: #1a237e;
            border-color: #42a5f5;
        }

        .stat-pill.cha {
            background: #880e4f;
            border-color: #f48fb1;
        }

        .desc-box {
            font-size: 0.75rem;
            line-height: 1.3;
            text-align: left;
            padding: 0 5px 5px 5px;
        }

        /* --- Ë£èÈù¢„Éá„Ç∂„Ç§„É≥ (Ê∑ª‰ªòÁîªÂÉèÂÜçÁèæ) --- */
        .back {
            transform: rotateY(180deg);
            background: #fffdf0;
            /* „ÇØ„É™„Éº„É†Ëâ≤ */
            color: #333;
            border: 8px solid #fff;
            outline: 2px solid #d4af37;
            outline-offset: -6px;
            /* Èáë„ÅÆÁ∏ÅÂèñ„Çä */
            padding: 15px;
            display: flex;
            flex-direction: column;
            font-family: var(--font-game);
        }

        /* ÂõõÈöÖ„ÅÆÈ£æ„Çä (Áñë‰ººË¶ÅÁ¥†„ÅßÂÜçÁèæ) */
        .back::before,
        .back::after {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            border: 2px solid #d4af37;
            pointer-events: none;
        }

        .back::before {
            top: 10px;
            left: 10px;
            border-right: none;
            border-bottom: none;
        }

        .back::after {
            bottom: 10px;
            right: 10px;
            border-left: none;
            border-top: none;
        }

        .back-header {
            text-align: center;
            padding-bottom: 5px;
            border-bottom: 1px solid #d4af37;
            margin-bottom: 10px;
        }

        .bk-name {
            font-size: 1.3rem;
            font-weight: 900;
        }

        .bk-kana {
            font-size: 0.8rem;
            font-weight: bold;
        }

        .bk-life {
            font-size: 0.9rem;
            margin-top: 2px;
        }

        .back-content {
            flex: 1;
            overflow-y: auto;
            text-align: left;
            font-size: 0.8rem;
        }

        /* Âπ¥Ë°®„Çπ„Çø„Ç§„É´ (Èªí„Ç´„Éó„Çª„É´ + Á∑ö) */
        .timeline-flow {
            margin: 5px 0 10px 10px;
            border-left: 2px solid #333;
            /* Á∏¶Á∑ö */
            padding-left: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tl-row {
            position: relative;
        }

        .tl-year {
            display: inline-block;
            background: #000;
            color: #fff;
            padding: 1px 8px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.8rem;
            position: relative;
            left: -25px;
            /* Á∑ö„ÅÆ‰∏ä„Å´ÈÖçÁΩÆ */
        }

        .tl-event {
            font-weight: bold;
            display: block;
            margin-top: 2px;
            line-height: 1.2;
        }

        /* Áü¢Âç∞ (Áñë‰ººË¶ÅÁ¥†) */
        .tl-row:not(:last-child)::after {
            content: '‚Üì';
            position: absolute;
            left: -21px;
            bottom: -12px;
            font-size: 0.8rem;
            color: #333;
            background: #fffdf0;
        }

        /* „Ç≠„Éº„ÉØ„Éº„Éâ */
        .bk-section-title {
            font-weight: bold;
            margin-top: 10px;
            color: #555;
            font-size: 0.8rem;
        }

        .kw-box {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-weight: bold;
            color: #333;
            margin-top: 2px;
        }

        .kw-item::before {
            content: "„Éª";
        }

        /* Ë™ûÂëÇÂêà„Çè„Åõ (È°î„Ç¢„Ç§„Ç≥„É≥‰ªò„Åç„Éú„ÉÉ„ÇØ„Çπ) */
        .memo-box {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            margin-top: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }

        .memo-icon {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            overflow: hidden;
            background: #2196f3;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .memo-text-area {
            display: flex;
            flex-direction: column;
        }

        .memo-label {
            font-size: 0.7rem;
            font-weight: bold;
            color: #555;
        }

        .memo-body {
            font-weight: bold;
            font-size: 0.85rem;
            line-height: 1.2;
        }

        /* Áõ∏Èñ¢Âõ≥ */
        .rel-diagram {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 15px;
            border: 1px solid #d4af37;
            padding: 5px;
            border-radius: 6px;
            background: #fff;
        }

        .rel-box {
            border: 1px solid #333;
            padding: 2px 4px;
            font-size: 0.65rem;
            border-radius: 3px;
            background: #fff;
            font-weight: bold;
        }

        .rel-box.main {
            background: #000;
            color: #fff;
        }

        .rel-arrow {
            font-size: 0.6rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
        }

        #sort-ui {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #sort-header {
            width: 100%;
            max-width: var(--menu-width);
            padding: 15px;
            background: #fff;
            border-bottom: 4px solid var(--primary);
            color: var(--primary);
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #sort-header .quit-btn {
            background: var(--primary);
            color: #fff;
            border-color: #d81b60;
            box-shadow: 0 4px 0 #d81b60;
        }

        #sort-header .quit-btn:active {
            box-shadow: 0 0 0 #d81b60;
            background: #c2185b;
            transform: translateY(4px);
        }

        #sort-container {
            width: 100%;
            max-width: var(--menu-width);
            flex: 1;
            overflow-y: auto;
            padding: 15px 0;
            position: relative;
            scroll-behavior: smooth;
        }

        .sort-item {
            width: 100%;
            background: #fff;
            padding: 20px;
            margin-bottom: 12px;
            border-radius: 16px;
            border: 3px solid #ffcc80;
            border-left: 8px solid var(--accent);
            cursor: grab;
            text-align: left;
            font-size: 1.2rem;
            color: var(--text-main);
            font-weight: bold;
            box-shadow: 0 4px 0 #ffcc80;
            touch-action: pan-y;
            user-select: none;
            transition: transform 0.2s, opacity 0.2s;
            position: relative;
        }

        .sort-item.dragging {
            opacity: 0;
        }

        .sort-placeholder {
            width: 100%;
            height: 60px;
            background: rgba(255, 215, 0, 0.2);
            border: 3px dashed var(--accent);
            border-radius: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-weight: 900;
            font-size: 1rem;
        }

        .sort-placeholder::after {
            content: "„Åì„Åì„Å´ÈÖçÁΩÆ";
        }

        .drag-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            width: 300px;
            background: #fff;
            padding: 20px;
            border-left: 8px solid var(--primary);
            color: var(--text-main);
            border-radius: 16px;
            font-weight: bold;
            box-shadow: 0 10px 20px rgba(255, 64, 129, 0.3);
            opacity: 0.9;
            transform: scale(1.05) rotate(2deg);
        }

        .sort-item.correct {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }

        .sort-item.wrong {
            border-left-color: #f44336;
            background: #ffebee;
        }

        #analysis-ui {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 243, 224, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .analysis-content {
            width: 100%;
            max-width: var(--menu-width);
        }

        .era-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 0 #ffcc80;
            width: 100%;
            color: var(--text-main);
        }

        .era-name {
            width: 60px;
            font-weight: bold;
        }

        .era-graph {
            flex: 1;
            height: 12px;
            background: #ffe0b2;
            margin: 0 10px;
            border-radius: 10px;
            overflow: hidden;
        }

        .era-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .era-rank {
            width: 30px;
            font-weight: bold;
            text-align: right;
            color: var(--primary);
        }

        .data-box {
            background: #fff;
            padding: 15px;
            border-radius: 16px;
            margin-top: 20px;
            border: 3px solid var(--accent);
            box-shadow: 0 4px 0 var(--accent);
            color: var(--text-main);
        }

        #export-area,
        #import-area {
            width: 100%;
            height: 60px;
            background: #fff9c4;
            color: var(--text-main);
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            font-weight: bold;
            margin-top: 5px;
        }

        .select-btn {
            background: #fff;
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            color: var(--text-main);
            border: 3px solid #ff9800;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 900;
            box-shadow: 0 4px 0 #ff9800;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .select-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #ff9800;
        }
    </style>
</head>

<body>

    <div id="main-wrapper">
        <div style="position: absolute; top: 10px; right: 10px; z-index: 500; display: flex; gap: 5px;">
            <button id="se-toggle-btn" class="quit-btn" style="margin: 0; padding: 5px 10px; font-size: 0.8rem;"
                onclick="toggleSe()">üîä ÂäπÊûúÈü≥</button>
            <button id="bgm-toggle-btn" class="quit-btn" style="margin: 0; padding: 5px 10px; font-size: 0.8rem;"
                onclick="toggleBgm()">üéµ BGM</button>
        </div>
        <div id="mode-screen" class="overlay-screen">
            <img src="./assets/images/logo_pop_kabuto.png" alt="Ê≠¥Âè≤ÁÑ°Âèå"
                style="width: 60%; max-width: 250px; margin-top: -20px; margin-bottom: 20px; filter: drop-shadow(0 4px 6px rgba(255, 64, 129, 0.4));" />
            <div class="menu-list">
                <button class="slash-btn" onclick="selectMode('battle')">
                    <div>
                        <div class="btn-title">ÁúüÂâ£ÂãùË≤†</div>
                        <div class="btn-sub">Battle Mode</div>
                    </div>
                    <div class="btn-icon">‚öîÔ∏è</div>
                </button>
                <button class="slash-btn" onclick="selectMode('flash')">
                    <div>
                        <div class="btn-title">ÊöóË®òÁâπË®ì</div>
                        <div class="btn-sub">Flash Cards</div>
                    </div>
                    <div class="btn-icon">üé¥</div>
                </button>
                <button class="slash-btn" onclick="selectMode('sort')">
                    <div>
                        <div class="btn-title">ÊôÇ‰ª£Êï¥Âàó</div>
                        <div class="btn-sub">Timeline Sort</div>
                    </div>
                    <div class="btn-icon">üìú</div>
                </button>
                <button class="slash-btn" onclick="selectMode('collection')">
                    <div>
                        <div class="btn-title">ÂÆùÁâ©Â∫´</div>
                        <div class="btn-sub">Collection</div>
                    </div>
                    <div class="btn-icon">üíé</div>
                </button>
                <button class="slash-btn" onclick="selectMode('analysis')">
                    <div>
                        <div class="btn-title">Êà¶Á∏æ„ÉªË®òÈå≤</div>
                        <div class="btn-sub">Data & Records</div>
                    </div>
                    <div class="btn-icon">üìä</div>
                </button>
            </div>
        </div>

        <div id="era-screen" class="overlay-screen hidden">
            <h2 style="margin-bottom:20px;">ÊôÇ‰ª£„ÇíÈÅ∏„Åπ</h2>
            <div class="menu-list">
                <button class="slash-btn" style="border-left-color:var(--accent);" onclick="selectEra('all')">
                    <div>
                        <div class="btn-title">ÂÖ®ÊôÇ‰ª£</div>
                        <div class="btn-sub">All Eras</div>
                    </div>
                </button>
                <button class="slash-btn" onclick="selectEra('Âè§‰ª£')">
                    <div>
                        <div class="btn-title">Âè§‰ª£</div>
                        <div class="btn-sub">Âº•Áîü~Âπ≥ÂÆâ</div>
                    </div>
                </button>
                <button class="slash-btn" onclick="selectEra('‰∏≠‰∏ñ')">
                    <div>
                        <div class="btn-title">‰∏≠‰∏ñ</div>
                        <div class="btn-sub">ÈéåÂÄâ~ÂÆ§Áî∫</div>
                    </div>
                </button>
                <button class="slash-btn" onclick="selectEra('Ëøë‰∏ñ')">
                    <div>
                        <div class="btn-title">Ëøë‰∏ñ</div>
                        <div class="btn-sub">ÂÆâÂúü~Ê±üÊà∏</div>
                    </div>
                </button>
                <button class="slash-btn" onclick="selectEra('Ëøë‰ª£')">
                    <div>
                        <div class="btn-title">Ëøë‰ª£</div>
                        <div class="btn-sub">ÊòéÊ≤ª~Êà¶Ââç</div>
                    </div>
                </button>
                <button class="slash-btn" onclick="selectEra('Áèæ‰ª£')">
                    <div>
                        <div class="btn-title">Áèæ‰ª£</div>
                        <div class="btn-sub">Êà¶Âæå~‰ª§Âíå</div>
                    </div>
                </button>
            </div>
            <button id="era-back-btn" class="quit-btn hidden"
                onclick="playSound('click'); document.getElementById('era-screen').classList.add('hidden'); document.getElementById('mode-screen').classList.remove('hidden');">Êàª„Çã</button>
        </div>

        <div id="star-screen" class="overlay-screen hidden">
            <h2 style="margin-bottom:20px;">ÈáçË¶ÅÂ∫¶„ÇíÈÅ∏„Åπ</h2>
            <div class="menu-list">
                <button class="slash-btn" style="border-left-color:var(--accent);" onclick="selectStar(0)">
                    <div>
                        <div class="btn-title">„Åô„Åπ„Å¶</div>
                        <div class="btn-sub">All Stars</div>
                    </div>
                </button>
                <button class="slash-btn" onclick="selectStar(1)">
                    <div>
                        <div class="btn-title">‚òÖ</div>
                        <div class="btn-sub">Âü∫Á§é„É¨„Éô„É´</div>
                    </div>
                </button>
                <button class="slash-btn" onclick="selectStar(2)">
                    <div>
                        <div class="btn-title">‚òÖ‚òÖ</div>
                        <div class="btn-sub">Ê®ôÊ∫ñ„É¨„Éô„É´</div>
                    </div>
                </button>
                <button class="slash-btn" onclick="selectStar(3)">
                    <div>
                        <div class="btn-title">‚òÖ‚òÖ‚òÖ</div>
                        <div class="btn-sub">ÈáçË¶Å„É¨„Éô„É´</div>
                    </div>
                </button>
            </div>
            <button class="quit-btn"
                onclick="playSound('click'); document.getElementById('star-screen').classList.add('hidden'); document.getElementById('era-screen').classList.remove('hidden');">Êàª„Çã</button>
        </div>

        <div id="diff-screen" class="overlay-screen hidden">
            <h2 style="margin-bottom:20px;">Êà¶Ê≥ï„ÇíÈÅ∏Êäû</h2>
            <div class="menu-list">
                <button class="slash-btn" onclick="startBattle('normal')">
                    <div>
                        <div class="btn-title">ÈÄöÂ∏∏ÂÆüÊà¶</div>
                        <div class="btn-sub">Standard</div>
                    </div>
                    <div class="btn-icon">‚öîÔ∏è</div>
                </button>
                <button class="slash-btn"
                    style="border-left-color: var(--accent); background: linear-gradient(90deg, #ffca28, #ffb300); color: #3e2723;"
                    onclick="startBattle('weak')">
                    <div>
                        <div class="btn-title">Ëã¶ÊâãÂÖãÊúç</div>
                        <div class="btn-sub">Weakness Training</div>
                    </div>
                    <div class="btn-icon">üî•</div>
                    <div id="weak-badge"
                        style="background:red; padding:2px 8px; border-radius:10px; font-size:0.8rem; font-weight:bold; margin-left:10px;">
                        0</div>
                </button>
            </div>
            <button class="quit-btn" onclick="playClickAndReload()">Êàª„Çã</button>
        </div>

        <div id="game-ui" class="hidden" style="height:100%; display:flex; flex-direction:column;">
            <div class="status-bar">
                <div style="width:40%">YOU<div class="hp-bar">
                        <div id="p-hp" class="hp-fill"></div>
                    </div>
                </div>
                <button class="quit-btn" style="margin:0; padding:5px 10px;" onclick="playClickAndReload()">ÈÄÉ„Åí„Çã</button>
                <div style="width:40%; text-align:right;">ENEMY<div class="hp-bar">
                        <div id="e-hp" class="hp-fill"></div>
                    </div>
                </div>
            </div>
            <div id="battle-stage">
                <div id="slash"></div>
                <div id="enemy-samurai"></div>
            </div>
            <div class="ui-mid">
                <div id="timer-gauge">
                    <div id="timer-fill"></div>
                </div>
                <div id="event-name">Âá∫Èô£</div>
                <div id="hint-text">üí° „Éí„É≥„Éà</div>
                <div id="input-display">____</div>
            </div>
            <div class="keypad">
                <button class="key" onclick="tapNum(1)">1</button><button class="key"
                    onclick="tapNum(2)">2</button><button class="key" onclick="tapNum(3)">3</button>
                <button class="key" onclick="tapNum(4)">4</button><button class="key"
                    onclick="tapNum(5)">5</button><button class="key" onclick="tapNum(6)">6</button>
                <button class="key" onclick="tapNum(7)">7</button><button class="key"
                    onclick="tapNum(8)">8</button><button class="key" onclick="tapNum(9)">9</button>
                <button class="key" onclick="tapClear()">C</button><button class="key"
                    onclick="tapNum(0)">0</button><button class="key ok" onclick="tapOk()">Êñ¨</button>
            </div>
        </div>

        <div id="flash-ui" class="overlay-screen hidden">
            <div id="fc-card" onclick="nextFcStep()"
                style="width:90%; height:60%; background:#fff; color:#000; border-radius:10px; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
                <h1 id="fc-year" style="font-size:4rem; margin:0;">----</h1>
                <h2 id="fc-goro" class="hidden" style="color:#b71c1c;">„Ç¥„É≠</h2>
                <div id="fc-event" class="hidden" style="font-size:1.5rem; font-weight:bold;">Âá∫Êù•‰∫ã</div>
                <div style="margin-top:auto; font-size:0.8rem; color:#888;">„Çø„ÉÉ„Éó„ÅßÈÄ≤„ÇÄ</div>
            </div>
            <div id="fc-actions" class="hidden"
                style="margin-top:20px; width:90%; display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                <button class="select-btn fc-btn memo-btn" onclick="rateCard('memo')">Ë¶ö„Åà„Åü</button>
                <button class="select-btn fc-btn norm-btn" onclick="rateCard('normal')">ÊôÆÈÄö</button>
                <button class="select-btn fc-btn weak-btn" onclick="rateCard('weak')">Ëã¶Êâã</button>
            </div>
            <button class="quit-btn" style="position:absolute; top:20px; right:20px;"
                onclick="playClickAndReload()">ÁµÇ‰∫Ü</button>
        </div>

        <div id="collection-ui" class="overlay-screen hidden" style="padding:0; justify-content:start;">
            <div id="col-header">
                <button class="quit-btn" style="margin:0;" onclick="playClickAndReload()">Êàª„Çã</button>
                <span>ÂÆùÁâ©Â∫´</span>
                <span id="col-count" style="margin-right: 80px;">0/0</span>
            </div>
            <div id="col-grid"></div>
        </div>

        <div id="card-modal" class="hidden">
            <h2 id="card-get-title" class="hidden"
                style="color:#ffd700; text-shadow:0 0 10px #ff0000; font-size:2.5rem; margin-bottom:20px; z-index:210;">
                „ÅäÂÆùÁô∫Ë¶ãÔºÅ</h2>
            <div id="card-view-node"></div>
            <button id="modal-close-btn" class="quit-btn" onclick="closeCardModal()">Èñâ„Åò„Çã</button>
            <p style="color:#fff; margin-top:10px; font-size:0.8rem; z-index:210;">„Ç´„Éº„Éâ„Çí„Çø„ÉÉ„Éó„ÅßË£èËøî„Åô</p>
            <div id="modal-bg-trigger" onclick="closeCardModal()"></div>
        </div>

        <div id="sort-ui" class="overlay-screen hidden">
            <div id="sort-header">
                <button class="quit-btn" style="margin:0;" onclick="playClickAndReload()">‰∏≠Êñ≠</button>
                <span>ÊôÇ‰ª£„Çí‰∏¶„ÅπÊõø„Åà„Çà</span>
                <button class="quit-btn" style="margin:0;" onclick="playSound('click'); checkSortOrder()">Âà§ÂÆö</button>
            </div>
            <div id="sort-container"></div>
        </div>

        <div id="analysis-ui" class="overlay-screen hidden">
            <div
                style="width:100%; display:flex; justify-content:space-between; margin-bottom:20px; max-width: var(--menu-width);">
                <h2>Êà¶Á∏æÂàÜÊûê</h2>
                <button class="quit-btn" style="margin:0;" onclick="playClickAndReload()">Èñâ„Åò„Çã</button>
            </div>
            <div id="analysis-container" class="analysis-content"></div>
            <div class="analysis-content" style="margin-top:20px;">
                <div class="data-box">
                    <p style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">„Éá„Éº„ÇøÂºïÁ∂ô„Åé</p>
                    <textarea id="export-area" readonly onclick="this.select()"></textarea>
                    <button class="select-btn" style="margin-top:5px; padding:8px; font-size:0.9rem;"
                        onclick="copyData()">„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº</button>
                </div>
                <div class="data-box">
                    <p style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">„Éá„Éº„ÇøÂæ©ÂÖÉ</p>
                    <textarea id="import-area" placeholder="„Åì„Åì„Å´„Ç≥„Éº„Éâ„ÇíË≤º„Çä‰ªò„Åë"></textarea>
                    <button class="select-btn"
                        style="margin-top:5px; padding:8px; font-size:0.9rem; border-color:var(--accent); color:var(--accent);"
                        onclick="importData()">„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ</button>
                </div>
            </div>
        </div>

        <div id="result-screen" class="overlay-screen hidden">
            <h1 id="res-title"></h1>
            <p id="res-msg"></p>
            <button class="quit-btn" onclick="playClickAndReload()">TOP„Å∏</button>
        </div>

        <div id="fc-result-screen" class="overlay-screen hidden">
            <h1 style="font-size: 2.5rem; margin-bottom: 10px; color: var(--primary);">ÁâπË®ìÂÆå‰∫Ü</h1>
            <p style="font-size: 1.2rem; margin-bottom: 30px;">„Åô„Åπ„Å¶„ÅÆ„Ç´„Éº„Éâ„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åó„Åü„ÄÇ</p>
            <button class="quit-btn"
                onclick="playSound('click'); document.getElementById('fc-result-screen').classList.add('hidden'); document.getElementById('era-back-btn').classList.remove('hidden'); document.getElementById('era-screen').classList.remove('hidden');">Èñâ„Åò„Çã</button>
        </div>

    </div>

    <!-- Audio Elements -->
    <audio id="bgm-main" src="./assets/audio/bgm_main.mp3" loop></audio>
    <audio id="se-decision" src="./assets/audio/se_decision.mp3"></audio>
    <audio id="se-cancel" src="./assets/audio/se_cancel.mp3"></audio>
    <audio id="se-slash" src="./assets/audio/se_slash.mp3"></audio>
    <audio id="se-battle" src="./assets/audio/se_battle.mp3"></audio>
    <audio id="se-click" src="./assets/audio/se_click.mp3"></audio>

    <script src="questions.js"></script>
    <script src="cards.js"></script>

    <script>
        const STORAGE_KEY = 'history_game_v1';
        let userStats = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        const CARD_STORAGE_KEY = 'history_game_cards_v1';
        let userCards = JSON.parse(localStorage.getItem(CARD_STORAGE_KEY)) || [];

        function getStat(id) { if (!userStats[id]) userStats[id] = { w: 0, s: 0, f: 0 }; return userStats[id]; }
        function saveStat(id, isCorrect, type = 'battle') {
            const s = getStat(id);
            if (type === 'battle') { if (isCorrect) s.s++; else { s.w++; s.s = 0; } }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(userStats));
        }

        // Audio Context (Keep for compatibility)
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        const SETTINGS_KEY = 'history_game_settings_v1';
        let userSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || { bgm: true, se: true };

        let isBgmPlaying = false;
        let isBgmEnabled = userSettings.bgm; // User preference toggle
        let isSeEnabled = userSettings.se;  // SE toggle
        let inBattle = false; // Track battle state

        // Initialize UI buttons on load
        window.addEventListener('DOMContentLoaded', () => {
            if (!isBgmEnabled) document.getElementById('bgm-toggle-btn').classList.add('gray-out');
            if (!isSeEnabled) document.getElementById('se-toggle-btn').classList.add('gray-out');
        });

        function playBgm() {
            if (isBgmEnabled && inBattle && !isBgmPlaying) {
                const bgm = document.getElementById('bgm-main');
                if (bgm && bgm.paused) {
                    bgm.volume = 0.3;
                    bgm.play().then(() => {
                        isBgmPlaying = true;
                    }).catch(e => console.log("BGM play failed:", e));
                }
            }
        }

        function stopBgm() {
            const bgm = document.getElementById('bgm-main');
            if (bgm && !bgm.paused) {
                bgm.pause();
                isBgmPlaying = false;
            }
        }

        function toggleBgm() {
            playSound('click');
            const btn = document.getElementById('bgm-toggle-btn');
            if (isBgmEnabled) {
                // Turn off
                isBgmEnabled = false;
                stopBgm();
                btn.classList.add('gray-out');
            } else {
                // Turn on
                isBgmEnabled = true;
                btn.classList.remove('gray-out');
                if (inBattle) playBgm();
            }
            userSettings.bgm = isBgmEnabled;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(userSettings));
        }

        function toggleSe() {
            playSound('click');
            const btn = document.getElementById('se-toggle-btn');
            if (isSeEnabled) {
                isSeEnabled = false;
                btn.classList.add('gray-out');
            } else {
                isSeEnabled = true;
                btn.classList.remove('gray-out');
            }
            userSettings.se = isSeEnabled;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(userSettings));
        }

        function playSound(type) {
            // Start BGM on first interaction as fallback
            if (inBattle) playBgm();

            if (!isSeEnabled) return;

            const audioMap = {
                'key': 'se-decision',
                'ok': 'se-battle',
                'cancel': 'se-cancel',
                'damage': 'se-cancel',
                'slash': 'se-slash',
                'click': 'se-click'
            };

            const id = audioMap[type];
            if (id) {
                const audio = document.getElementById(id);
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log("SE play failed:", e));
                }
            }
        }

        let mode = '', selectedEra = '', selectedStars = 0, playerHp = 100, enemyHp = 100, currentIdx = 0, quizList = [], userInput = "", timerInterval;
        let isProcessing = false;

        function selectMode(m) {
            playSound('click');
            mode = m;
            document.getElementById('mode-screen').classList.add('hidden');
            if (m === 'collection') showCollection();
            else if (m === 'sort') startSortGame();
            else if (m === 'analysis') showAnalysis();
            else {
                // Determine if we should show the back button on Era screen
                // Only show it if we are entering from mode selection
                document.getElementById('era-back-btn').classList.remove('hidden');
                document.getElementById('era-screen').classList.remove('hidden');
            }
        }

        function selectEra(era) {
            playSound('click');
            selectedEra = era;
            document.getElementById('era-screen').classList.add('hidden');
            document.getElementById('star-screen').classList.remove('hidden');
        }

        function selectStar(stars) {
            playSound('click');
            selectedStars = stars;
            document.getElementById('star-screen').classList.add('hidden');

            if (mode === 'battle') {
                let data = (typeof masterData !== 'undefined') ? masterData : [];
                const weakCount = data.filter(q =>
                    (selectedEra === 'all' || q.era === selectedEra) &&
                    (selectedStars === 0 || q.stars === selectedStars) &&
                    getStat(q.id).w > 0
                ).length;
                const badge = document.getElementById('weak-badge');
                badge.innerText = weakCount;
                badge.style.display = weakCount > 0 ? 'inline-block' : 'none';
                document.getElementById('diff-screen').classList.remove('hidden');
            }
            else startFlash();
        }

        function playClickAndReload() {
            playSound('click');
            setTimeout(() => location.reload(), 150);
        }

        function startBattle(type) {
            playSound('click');
            inBattle = true;
            playBgm();
            document.getElementById('diff-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            let data = (typeof masterData !== 'undefined') ? masterData : [];
            let baseList = data.filter(q =>
                (selectedEra === 'all' || q.era === selectedEra) &&
                (selectedStars === 0 || q.stars === selectedStars)
            );
            if (type === 'weak') {
                quizList = baseList.filter(q => getStat(q.id).w > 0 && getStat(q.id).s < 3);
                if (quizList.length === 0) { alert("Ëã¶Êâã„ÅÆË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºÅ"); location.reload(); return; }
                quizList.sort((a, b) => getStat(b.id).w - getStat(a.id).w);
            } else { quizList = baseList.sort(() => Math.random() - 0.5); }
            quizList = quizList.slice(0, 10);
            playerHp = 100; enemyHp = 100; currentIdx = 0; isProcessing = false;
            updateHp(); showQ();
        }
        function updateHp() { document.getElementById('p-hp').style.width = Math.max(0, playerHp) + "%"; document.getElementById('e-hp').style.width = Math.max(0, enemyHp) + "%"; }
        function showQ() {
            if (playerHp <= 0 || enemyHp <= 0 || currentIdx >= quizList.length) { endGame(); return; }
            isProcessing = false;
            userInput = ""; document.getElementById('input-display').innerText = "____";
            document.getElementById('input-display').style.color = "";
            document.getElementById('event-name').innerText = quizList[currentIdx].e;
            const hint = document.getElementById('hint-text');
            hint.innerText = quizList[currentIdx].h || "„Éí„É≥„Éà„Å™„Åó"; hint.style.opacity = 0;
            currentIdx < quizList.length ? startTimer() : endGame();
        }
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            let s = Date.now();
            timerInterval = setInterval(() => {
                let elapsed = Date.now() - s;
                let ratio = 1 - (elapsed / 10000);
                document.getElementById('timer-fill').style.width = Math.max(0, ratio * 100) + "%";
                if (ratio < 0.5) document.getElementById('hint-text').style.opacity = 1;
                if (elapsed > 10000) { clearInterval(timerInterval); processResult(false); }
            }, 100);
        }
        function tapNum(n) { if (userInput.length < 4) { userInput += n; document.getElementById('input-display').innerText = userInput; playSound('key'); } }
        function tapClear() { userInput = ""; document.getElementById('input-display').innerText = "____"; }
        function tapOk() {
            if (isProcessing) return;
            if (userInput) {
                isProcessing = true;
                clearInterval(timerInterval); processResult(userInput === quizList[currentIdx].y);
            }
        }
        function processResult(win) {
            saveStat(quizList[currentIdx].id, win, 'battle');
            if (win) {
                playSound('slash'); enemyHp -= 25;
                document.getElementById('slash').classList.remove('slash-anim'); void document.getElementById('slash').offsetWidth; document.getElementById('slash').classList.add('slash-anim');
                document.getElementById('input-display').style.color = "#4caf50";
            } else {
                playSound('damage'); playerHp -= 30;
                document.getElementById('input-display').style.color = "#f44336"; document.getElementById('input-display').innerText = quizList[currentIdx].y;
            }
            updateHp(); setTimeout(() => { currentIdx++; showQ(); }, 1500);
        }

        function endGame() {
            inBattle = false;
            stopBgm();
            document.getElementById('game-ui').classList.add('hidden');
            // Make it a win if enemy HP <= 0 OR if we ran out of questions and player HP > enemy HP
            const win = enemyHp <= 0 || (currentIdx >= quizList.length && playerHp > enemyHp);
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('res-title').innerText = win ? "ÂãùÂà©" : "ÊïóÂåó";
            document.getElementById('res-msg').innerText = win ? "Ê≠¥Âè≤„ÅÆÈóá„ÇíÂàá„ÇäË£Ç„ÅÑ„ÅüÔºÅ" : "‰øÆË°å„Åó„Å¶Âá∫Áõ¥„Åõ„ÄÇ";

            if (win) {
                let cData = (typeof cardData !== 'undefined') ? cardData : [];
                if (cData.length > 0) {
                    // „Éâ„É≠„ÉÉ„Éó„É≠„Ç∏„ÉÉ„ÇØ: 70%„Åß„Ç¢„Ç§„ÉÜ„É†(N)„ÄÅ30%„ÅßÂÅâ‰∫∫(R‰ª•‰∏ä)
                    // „Éé„Éº„Éû„É´„Ç´„Éº„Éâ„ÇíÂ§ö„Åè„Åô„Çã (User Request)
                    const rand = Math.random();
                    let pool = [];
                    if (rand < 0.7) {
                        pool = cData.filter(c => c.type === 'item');
                        if (pool.length === 0) pool = cData;
                    } else {
                        pool = cData.filter(c => c.type !== 'item');
                        if (pool.length === 0) pool = cData;
                    }

                    const drop = pool[Math.floor(Math.random() * pool.length)];
                    const isNew = !userCards.includes(drop.id);
                    userCards.push(drop.id);
                    localStorage.setItem(CARD_STORAGE_KEY, JSON.stringify(userCards));
                    setTimeout(() => openCardModal(drop, isNew), 500);
                }
            }
        }

        function showCollection() {
            document.getElementById('collection-ui').classList.remove('hidden');
            const grid = document.getElementById('col-grid');
            grid.innerHTML = "";
            let cData = (typeof cardData !== 'undefined') ? [...cardData] : [];
            cData.sort((a, b) => parseInt(a.id.substring(1)) - parseInt(b.id.substring(1)));
            cData.forEach(c => {
                const count = userCards.filter(id => id === c.id).length;
                const owned = count > 0;
                const el = document.createElement('div');
                el.className = `col-card ${owned ? 'r' + c.rarity : ''}`;
                el.innerHTML = `
                    <div class="col-card-num">No.${c.id.substring(1)}</div>
                    ${count > 1 ? `<div class="col-card-badge">x${count}</div>` : ''}
                    <div style="width:100%; flex:1; display:flex; justify-content:center; align-items:center; background:#fff; margin:2px 0; border-radius:2px; overflow:hidden;">
                        ${owned ? `<img src="${c.img}" style="width:100%;height:100%;object-fit:cover;">` : '<span style="color:#000;font-size:1.5rem;">?</span>'}
                    </div>
                    <div class="col-card-name">${owned ? c.name : '???'}</div>
                `;
                el.onclick = () => { if (owned) openCardModal(c, false); };
                grid.appendChild(el);
            });
            const uniqueOwned = new Set(userCards).size;
            document.getElementById('col-count').innerText = `${uniqueOwned} / ${cData.length}`;
        }

        function openCardModal(card, isNew) {
            const modal = document.getElementById('card-modal');
            modal.classList.remove('hidden');
            document.getElementById('card-get-title').classList.toggle('hidden', !isNew);
            if (isNew) playSound('ok');

            const view = document.getElementById('card-view-node');
            const s = card.stats || { str: 10, int: 10, cha: 10 };

            const isItem = card.type === 'item';

            view.innerHTML = `
                <div class="flip-container" onclick="toggleFlip(this)">
                    <div class="flipper">
                        <div class="front" data-rarity="${card.rarity}">
                            <div class="front-inner">
                                <div class="card-bg"></div>
                                <div class="card-header">
                                    <div class="era-badge"><div class="era-icon">üèØ</div><div class="era-text">${card.group || 'Ê≠¥Âè≤'}</div></div>
                                    <div class="name-container"><div class="card-title">${card.title || 'Ê≠¥Âè≤ÈÅ∫Áî£'}</div><div class="card-name">${card.name}</div></div>
                                    <div class="rarity-star"><svg class="star-svg" viewBox="0 0 24 24"><polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9"/></svg><span class="rarity-text">${["?", "N", "R", "SR", "SSR"][card.rarity] || "N"}</span></div>
                                </div>
                                <img src="${card.img}" class="card-char-img" style="${isItem ? 'width:70%; bottom:110px;' : ''}">
                                <div class="card-no">No.${card.id.substring(1)}</div>
                                <div class="card-bottom">
                                    ${!isItem ? `<div class="stats-row"><div class="stat-pill str"><div>‚öîÔ∏è„Å§„Çà„Åï</div><div class="stat-val">${s.str}</div></div><div class="stat-pill int"><div>üß†„Åã„Åó„Åì„Åï</div><div class="stat-val">${s.int}</div></div><div class="stat-pill cha"><div>üíó„Å´„Çì„Åç</div><div class="stat-val">${s.cha}</div></div></div>` : ''}
                                    <div class="desc-box" style="${isItem ? 'margin-top:5px; height:75px;' : ''}">${card.desc}</div>
                                </div>
                            </div>
                        </div>
                        <div class="back">
                            <div class="back-header">
                                <div class="bk-name">${card.name}</div><div class="bk-kana">${card.kana || ''}</div><div class="bk-life">${card.lifespan || 'Âà∂‰ΩúÂπ¥‰∏çË©≥'} [${card.group}]</div>
                            </div>
                            <div class="back-content">
                                <div class="timeline-flow">${(card.timeline || []).map(t => `<div class="tl-row"><span class="tl-year">${t.y}</span><span class="tl-event">${t.e}</span></div>`).join('')}</div>
                                <div class="kw-box">${(card.keywords || []).map(k => `<span class="kw-item">${k}</span>`).join('')}</div>
                                <div class="memo-box"><div class="memo-icon">üò≠</div><div class="memo-text-area"><div class="memo-label">„Åä„Åº„Åà„Çà„ÅÜÔºÅ</div><div class="memo-body">${card.mnemonic || 'Áâπ„Å´„Å™„Åó'}</div></div></div>
                                ${!isItem ? `<div class="rel-diagram">${(card.relations || []).map(r => `<div class="rel-box">${r.name}</div><div class="rel-arrow"><span>${r.dir === 'to' ? '‚û°' : '‚¨Ö'}</span><span>${r.type}</span></div>`).join('')}<div class="rel-box main">${card.name}</div></div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function toggleFlip(el) { el.classList.toggle('flipped'); }
        function closeCardModal() { document.getElementById('card-modal').classList.add('hidden'); }

        // --- „Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ ---
        let fcStep = 0;
        function startFlash() {
            playSound('click');
            document.getElementById('flash-ui').classList.remove('hidden');
            let data = (typeof masterData !== 'undefined') ? masterData : [];
            quizList = data.filter(q =>
                (selectedEra === 'all' || q.era === selectedEra) &&
                (selectedStars === 0 || q.stars === selectedStars)
            ).sort(() => Math.random() - 0.5); // Shuffle for flashcards too
            currentIdx = 0; showFc();
        }
        function showFc() {
            if (currentIdx >= quizList.length) {
                document.getElementById('flash-ui').classList.add('hidden');
                document.getElementById('fc-result-screen').classList.remove('hidden');
                return;
            }
            fcStep = 0;
            document.getElementById('fc-year').innerText = quizList[currentIdx].y;
            document.getElementById('fc-goro').classList.add('hidden'); document.getElementById('fc-goro').innerText = quizList[currentIdx].h;
            document.getElementById('fc-event').classList.add('hidden'); document.getElementById('fc-event').innerText = quizList[currentIdx].e;
            document.getElementById('fc-actions').classList.add('hidden');
        }
        function nextFcStep() {
            playSound('click');
            fcStep++;
            if (fcStep === 1) document.getElementById('fc-goro').classList.remove('hidden');
            if (fcStep === 2) { document.getElementById('fc-event').classList.remove('hidden'); document.getElementById('fc-actions').classList.remove('hidden'); }
        }
        function rateCard(r) { playSound('click'); currentIdx++; showFc(); }

        // --- Êï¥Âàó„Ç≤„Éº„É† ---
        const correctOrder = ["Âº•Áîü", "Âè§Â¢≥", "È£õÈ≥•", "Â•àËâØ", "Âπ≥ÂÆâ", "ÈéåÂÄâ", "ÂÆ§Áî∫", "ÂÆâÂúüÊ°ÉÂ±±", "Ê±üÊà∏", "ÊòéÊ≤ª", "Â§ßÊ≠£", "Êò≠Âíå", "Âπ≥Êàê", "‰ª§Âíå"];
        let ghost = null; let placeholder = null; let dragSrcEl = null; let pressTimer = null; let isDragging = false;

        function startSortGame() {
            playSound('click');
            document.getElementById('sort-ui').classList.remove('hidden');
            const c = document.getElementById('sort-container'); c.innerHTML = "";
            const shuffled = [...correctOrder].sort(() => Math.random() - 0.5);
            shuffled.forEach(era => {
                const d = document.createElement('div'); d.className = 'sort-item'; d.innerText = era;
                d.addEventListener('touchstart', handlePointerDown, { passive: false });
                d.addEventListener('mousedown', handlePointerDown, { passive: false });
                c.appendChild(d);
            });

            // Global listeners for smooth dragging out of item bounds
            document.addEventListener('touchmove', handlePointerMove, { passive: false });
            document.addEventListener('mousemove', handlePointerMove, { passive: false });
            document.addEventListener('touchend', handlePointerEnd);
            document.addEventListener('mouseup', handlePointerEnd);
        }

        function getClientPos(e) {
            // Unify touch and mouse coordinates
            if (e.touches && e.touches.length > 0) {
                return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
            } else if (e.changedTouches && e.changedTouches.length > 0) {
                return { clientX: e.changedTouches[0].clientX, clientY: e.changedTouches[0].clientY };
            } else {
                return { clientX: e.clientX, clientY: e.clientY };
            }
        }

        function handlePointerDown(e) {
            const target = e.target;
            pressTimer = setTimeout(() => {
                isDragging = true; dragSrcEl = target; initiateDrag(getClientPos(e));
            }, 100);
        }

        function initiateDrag(pos) {
            if (!dragSrcEl) return;
            if (navigator.vibrate) navigator.vibrate(20);
            ghost = dragSrcEl.cloneNode(true); ghost.className = 'drag-ghost'; document.body.appendChild(ghost);
            moveGhost(pos);
            placeholder = document.createElement('div'); placeholder.className = 'sort-placeholder';
            dragSrcEl.parentNode.insertBefore(placeholder, dragSrcEl.nextSibling);
            dragSrcEl.style.display = 'none';
        }

        function handlePointerMove(e) {
            if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; }
            if (!isDragging) return;
            e.preventDefault(); const pos = getClientPos(e); moveGhost(pos);
            const container = document.getElementById('sort-container');
            const rect = container.getBoundingClientRect();
            if (pos.clientY < rect.top + 80) container.scrollTop -= 10;
            else if (pos.clientY > rect.bottom - 80) container.scrollTop += 10;

            let element = document.elementFromPoint(pos.clientX, pos.clientY);
            if (element && element.classList.contains('sort-item') && element !== dragSrcEl) {
                const bounding = element.getBoundingClientRect();
                const offset = bounding.y + (bounding.height / 2);
                if (pos.clientY - offset > 0) container.insertBefore(placeholder, element.nextSibling);
                else container.insertBefore(placeholder, element);
            }
        }

        function handlePointerEnd(e) {
            if (pressTimer) clearTimeout(pressTimer);
            if (isDragging) {
                isDragging = false;
                if (dragSrcEl) {
                    dragSrcEl.style.display = 'block';
                    if (placeholder && placeholder.parentNode) { placeholder.parentNode.insertBefore(dragSrcEl, placeholder); placeholder.remove(); }
                    dragSrcEl = null; placeholder = null;
                }
                if (ghost) { ghost.remove(); ghost = null; }
                playSound('damage');
            }
        }
        function moveGhost(pos) { if (ghost) { ghost.style.left = (pos.clientX - 20) + 'px'; ghost.style.top = (pos.clientY - 20) + 'px'; } }
        function checkSortOrder() {
            const items = document.querySelectorAll('.sort-item'); let correctCount = 0;
            items.forEach((item, index) => {
                if (item.innerText === correctOrder[index]) { item.classList.add('correct'); item.classList.remove('wrong'); correctCount++; }
                else { item.classList.add('wrong'); item.classList.remove('correct'); }
            });
            if (correctCount === correctOrder.length) { alert("Ë¶ã‰∫ãÔºÅÂÖ®ÂïèÊ≠£Ëß£ÔºÅ"); playSound('ok'); } else { alert(`${correctCount}ÂÄã Ê≠£Ëß£ÔºÅ`); }
        }

        function showAnalysis() {
            document.getElementById('analysis-ui').classList.remove('hidden');
            const container = document.getElementById('analysis-container'); container.innerHTML = "";
            const eras = ['Âè§‰ª£', '‰∏≠‰∏ñ', 'Ëøë‰∏ñ', 'Ëøë‰ª£', 'Áèæ‰ª£'];
            let data = (typeof masterData !== 'undefined') ? masterData : [];
            eras.forEach(era => {
                const eraQs = data.filter(q => q.era === era);
                if (eraQs.length === 0) return;
                let score = 0;
                eraQs.forEach(q => { const s = getStat(q.id); if (s.s > 0) score += 10; if (s.w > 0) score -= 5; });
                let rate = Math.max(0, Math.min(100, (score / (eraQs.length * 10)) * 100));
                let rank = 'D', color = '#888'; if (rate > 80) { rank = 'S'; color = 'var(--accent)'; } else if (rate > 60) { rank = 'A'; color = '#ff4081'; } else if (rate > 40) { rank = 'B'; color = '#4caf50'; }
                container.innerHTML += `<div class="era-row"><div class="era-name">${era}</div><div class="era-graph"><div class="era-bar" style="width:${rate}%; background:${color};"></div></div><div class="era-rank" style="color:${color};">${rank}</div></div>`;
            });
            setTimeout(() => { document.querySelectorAll('.era-bar').forEach(el => { const w = el.style.width; el.style.width = '0%'; setTimeout(() => el.style.width = w, 50); }); }, 100);
            const exportData = { v: 2, s: userStats, c: userCards };
            document.getElementById('export-area').value = btoa(unescape(encodeURIComponent(JSON.stringify(exportData))));
        }
        function copyData() { document.getElementById("export-area").select(); document.execCommand("copy"); alert("„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ"); }
        function importData() {
            const code = document.getElementById('import-area').value; if (!code) return;
            try {
                const json = JSON.parse(decodeURIComponent(escape(atob(code))));
                if (json.v === 2 && confirm("Âæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü")) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(json.s)); localStorage.setItem(CARD_STORAGE_KEY, JSON.stringify(json.c));
                    alert("ÂÆå‰∫Ü"); location.reload();
                }
            } catch (e) { alert("„Ç®„É©„Éº"); }
        }
    </script>
</body>

</html>